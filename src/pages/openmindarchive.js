import WhitePillButton from "../components/Buttons/wpillbutton"
import React, { useState, useEffect } from "react";
import axios from "axios"

export default function OMA() {
    const [topic, setTopic]  = useState("");
    const [allTopics, setAllTopics]  = useState([]); // [["omid", user_id, "body", time_created]]
    
    // constant query from backend with react... should you use useEffect?
    useEffect(() => {
        if (!allTopics.length){
            getTopics(-1) // GET everything from open mind api
        }
        const interval = setInterval(() => {
            let latestId = allTopics[allTopics.length-1].omid;
            getTopics(latestId)
        },10000)

        return()=>clearInterval(interval)
    }, [])

    const handleSubmit = (e) => {
        e.preventDefault();
        let sendTopic = {
            user_id: 1,
            body:topic,
        }
        axios.post("http://localhost:5000/api/openmind", sendTopic)
        .then((res)=>{
            console.log(sendTopic)
        })
        .catch((err)=>{/*alert(err)*/})
    }

    const getTopics = (lastId) => {
        let getRecentTopics = {
            params:{
                query: lastId
            }
        }
        axios.get("http://localhost:5000/api/openmind", "")
        .then((res)=>{
            setAllTopics([...allTopics, ...res.data])
        })
        .catch((err)=>{alert(err)})
    }
    return (
        <>  
            <div className="grid mx-8 sm:grid-cols-2">
                <div className="col-span-1 sm:mr-6">
                    <p className="sm:my-8">Open Mind Archive</p>
                    <p className="text-4xl sm:mt-24 sm:mb-2">What's a topic you're curious to learn more about?</p>
                    <p className="">A curiousity bank generated by the Schefs community.</p>
                </div>
                <div className="col-span-1">            
                    <div className="grid rows-7 h-screen/1.25 pb-4 bg-gray-200">

                        <div className="row-span-6 bg-gray-400">
                            <ul>
                                {allTopics.map(topic=>(
                                    <li key={topic.omid}>{topic.body}</li>
                                ))}
                            </ul>
                        </div>

                        <form className="flex row-span-1 items-end justify-center" onSubmit={handleSubmit}>
                                <input className="w-2/10 border-b border-black focus:outline-none" type="text" value={topic} onChange={(e) => setTopic(e.target.value)} aria-label="Add a topic"  />
                                <WhitePillButton type="submit" text="POST" size="lg" />
                        </form>
                    </div>
                </div>
            </div>
        </>
  );
};
